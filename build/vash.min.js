(function(a){typeof define=="function"&&define.amd?define(a):typeof module=="object"&&module.exports?module.exports=a:window.vash=a})(function(a){function g(a,b){this.ast=a,this.originalMarkup=b||""}function f(a,b){var c;this.options=b||{},this.tokens=a,this.ast=new d,this.debug=this.options.debugParser}function e(){this.type="",this.tagName=null,this.parent=null,this.starter=[],this.children=[],this.stopper=[]}function d(a){this.current=this.openNew(f.modes.PRG),this.rootNode=this.current}function c(a){this.input=this.originalInput=a.replace(/\r\n|\r/g,"\n"),this.lineno=1,this.charno=0}var b=a;a.version="0.4.1-672",a.config={useWith:!1,modelName:"model",debug:!1,debugParser:!1,debugCompiler:!1},c.prototype={tok:function(a,b){return{type:a,line:this.lineno,chr:this.charno,val:b,toString:function(){return(this.mode?this.mode:"")+"["+this.type+" ("+this.line+","+this.chr+"): "+this.val+"]"}}},scan:function(a,b){var c,d;if(c=a.exec(this.input)){this.consume(c[0].length),d=this.tok(b,c[1]),this.charno+=c[0].length;return d}},spew:function(a){this.input=a+this.input,this.charno-=a.length},consume:function(a){this.input=this.input.substr(a)},spewIf:function(a,b){var c;a&&(c=a.val.split(b),c.length>1&&(a.val=c.shift(),this.spew(b+c.join(b))));return a},advance:function(){return this.next()},next:function(){return this.EMAIL()||this.AT_STAR_OPEN()||this.AT_STAR_CLOSE()||this.AT_COLON()||this.AT()||this.FAT_ARROW()||this.PAREN_OPEN()||this.PAREN_CLOSE()||this.HARD_PAREN_OPEN()||this.HARD_PAREN_CLOSE()||this.BRACE_OPEN()||this.BRACE_CLOSE()||this.TEXT_TAG_OPEN()||this.TEXT_TAG_CLOSE()||this.HTML_TAG_SELFCLOSE()||this.HTML_TAG_OPEN()||this.HTML_TAG_CLOSE()||this.PERIOD()||this.NEWLINE()||this.WHITESPACE()||this.FUNCTION()||this.KEYWORD()||this.HTML_RAW()||this.IDENTIFIER()||this.OPERATOR()||this.ASSIGN_OPERATOR()||this.LOGICAL()||this.DOUBLE_QUOTE()||this.SINGLE_QUOTE()||this.NUMERIC_CONTENT()||this.CONTENT()},AT:function(){return this.scan(/^(@)/,c.tks.AT)},AT_COLON:function(){return this.scan(/^@\:/,c.tks.AT_COLON)},AT_STAR_OPEN:function(){return this.scan(/^(@\*)/,c.tks.AT_STAR_OPEN)},AT_STAR_CLOSE:function(){return this.scan(/^(\*@)/,c.tks.AT_STAR_CLOSE)},PAREN_OPEN:function(){return this.scan(/^(\()/,c.tks.PAREN_OPEN)},PAREN_CLOSE:function(){return this.scan(/^(\))/,c.tks.PAREN_CLOSE)},BRACE_OPEN:function(){return this.scan(/^(\{)/,c.tks.BRACE_OPEN)},BRACE_CLOSE:function(){return this.scan(/^(\})/,c.tks.BRACE_CLOSE)},HARD_PAREN_OPEN:function(){return this.scan(/^(\[)/,c.tks.HARD_PAREN_OPEN)},HARD_PAREN_CLOSE:function(){return this.scan(/^(\])/,c.tks.HARD_PAREN_CLOSE)},TEXT_TAG_OPEN:function(){return this.scan(/^(<text>)/,c.tks.TEXT_TAG_OPEN)},TEXT_TAG_CLOSE:function(){return this.scan(/^(<\/text>)/,c.tks.TEXT_TAG_CLOSE)},HTML_TAG_SELFCLOSE:function(){return this.spewIf(this.scan(/^(<[^>]+?\/>)/,c.tks.HTML_TAG_SELFCLOSE),"@")},HTML_TAG_OPEN:function(){return this.spewIf(this.scan(/^(<[^\/ >]+?[^>]*?>)/,c.tks.HTML_TAG_OPEN),"@")},HTML_TAG_CLOSE:function(){return this.spewIf(this.scan(/^(<\/[^>\b]+?>)/,c.tks.HTML_TAG_CLOSE),"@")},FAT_ARROW:function(){return this.scan(/^(\(.*?\)?\s*?=>)/,c.tks.FAT_ARROW)},FUNCTION:function(){return this.scan(/^(function)(?![\d\w])/,c.tks.FUNCTION)},KEYWORD:function(){return this.scan(/^(case|catch|do|else|finally|for|function|goto|if|instanceof|return|switch|try|typeof|var|while|with)(?![\d\w])/,c.tks.KEYWORD)},IDENTIFIER:function(){return this.scan(/^([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)/,c.tks.IDENTIFIER)},HTML_RAW:function(){return this.scan(/^(vash\.raw)(?![\d\w])/,c.tks.HTML_RAW)},PERIOD:function(){return this.scan(/^(\.)/,c.tks.PERIOD)},EMAIL:function(){return this.scan(/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})\b/,c.tks.EMAIL)},ASSIGN_OPERATOR:function(){return this.scan(/^(\|=|\^=|&=|>>>=|>>=|<<=|-=|\+=|%=|\/=|\*=|=)/,c.tks.ASSIGN_OPERATOR)},OPERATOR:function(){return this.scan(/^(===|!==|==|!==|>>>|<<|>>|>=|<=|>|<|\+|-|\/|\*|\^|%|\:|\?)/,c.tks.OPERATOR)},LOGICAL:function(){return this.scan(/^(&&|\|\||&|\||\^)/,c.tks.LOGICAL)},SINGLE_QUOTE:function(){return this.scan(/^(\\?')/,c.tks.SINGLE_QUOTE)},DOUBLE_QUOTE:function(){return this.scan(/^(\\?")/,c.tks.DOUBLE_QUOTE)},NUMERIC_CONTENT:function(){return this.scan(/^([0-9]+)/,c.tks.NUMERIC_CONTENT)},CONTENT:function(){return this.scan(/^([^\s})@.]+?)/,c.tks.CONTENT)},WHITESPACE:function(){return this.scan(/^(\s)/,c.tks.WHITESPACE)},NEWLINE:function(){var a=this.scan(/^(\n)/,c.tks.NEWLINE);a&&(this.lineno++,this.charno=0);return a},EOF:function(){return this.scan(/^$/,c.tks.EOF)}},c.tks={AT:"AT",AT_STAR_OPEN:"AT_STAR_OPEN",AT_STAR_CLOSE:"AT_STAR_CLOSE",AT_COLON:"AT_COLON",EMAIL:"EMAIL",PAREN_OPEN:"PAREN_OPEN",PAREN_CLOSE:"PAREN_CLOSE",BRACE_OPEN:"BRACE_OPEN",BRACE_CLOSE:"BRACE_CLOSE",HARD_PAREN_OPEN:"HARD_PAREN_OPEN",HARD_PAREN_CLOSE:"HARD_PAREN_CLOSE",TEXT_TAG_OPEN:"TEXT_TAG_OPEN",TEXT_TAG_CLOSE:"TEXT_TAG_CLOSE",HTML_TAG_SELFCLOSE:"HTML_TAG_SELFCLOSE",HTML_TAG_OPEN:"HTML_TAG_OPEN",HTML_TAG_CLOSE:"HTML_TAG_CLOSE",KEYWORD:"KEYWORD",FUNCTION:"FUNCTION",FAT_ARROW:"FAT_ARROW",IDENTIFIER:"IDENTIFIER",PERIOD:"PERIOD",ASSIGN_OPERATOR:"ASSIGN_OPERATOR",SINGLE_QUOTE:"SINGLE_QUOTE",DOUBLE_QUOTE:"DOUBLE_QUOTE",NUMERIC_CONTENT:"NUMERIC_CONTENT",OPERATOR:"OPERATOR",LOGICAL:"LOGICAL",CONTENT:"CONTENT",WHITESPACE:"WHITESPACE",NEWLINE:"NEWLINE",EOF:"EOF",HTML_RAW:"HTML_RAW"},c.pairs={AT_STAR_OPEN:c.tks.AT_STAR_CLOSE,PAREN_OPEN:c.tks.PAREN_CLOSE,BRACE_OPEN:c.tks.BRACE_CLOSE,HARD_PAREN_OPEN:c.tks.HARD_PAREN_CLOSE,DOUBLE_QUOTE:c.tks.DOUBLE_QUOTE,SINGLE_QUOTE:c.tks.SINGLE_QUOTE},d.prototype.root=function(){this.current=this.rootNode;return this.rootNode},d.prototype.useToken=function(a){var c=this.current.closed()||this.current.children.length>0?this.useAsStopper:this.useAsStarter;a=b.isArray(a)?a:[a];for(var d=0;d<a.length;d++)c.call(this,a[d])},d.prototype.useAsStarter=function(a){this.current.starter.push(a)},d.prototype.useAsStopper=function(a){this.current.stopper.push(a)},d.prototype.openNew=function(a,b){var c=new e;c.type=a,c.parent=b||this.current;return c},d.prototype.openNewAsChild=function(a,b,c){var d;this.current.closed()?this.openNewAsSibling(a,b):(c!==!0&&this.current.children.length===0&&this.current.starter.length===0&&this.current.stopper.length===0&&this.current.type!==f.modes.PRG?(d=this.current,this.current.type=a):(d=this.openNew(a,this.current),this.current.children.push(d),this.current=d),b&&d.starter.push(b))},d.prototype.openNewAsSibling=function(a,b){var c=this.openNew(a,this.current.parent);b&&c.starter.push(b),c.parent.children.push(c),this.current=c},d.prototype.closeCurrent=function(){this.current=this.current.parent},d.prototype.searchParentsFor=function(a,b){var c=this.current;while(c&&c.parent&&c[a]!==b&&(c=c.parent));return c[a]!==b?null:c},d.prototype.searchParentsByTypeFor=function(a,b,c){var d=this.current;while(d&&d[b]!==c&&d.type!==a&&(d=d.parent));return d[b]!==c?null:d},d.prototype.flatten=function(){function b(c){var d,e;c.starter.forEach(function(a){a.mode=c.type}),c.stopper.forEach(function(a){a.mode=c.type}),a.push.apply(a,c.starter),e=c.children.slice();while(d=e.shift())b(d);a.push.apply(a,c.stopper)}var a=[];b(this.current);return a},d.prototype.toTreeString=function(){function d(e){var f,g;a.push(Array(b-1).join(" |")+" +"+e.type),a.push.apply(a,c(e.starter,b)),b+=2,f=e.children.slice();while(g=f.shift())d(g);b-=2,a.push.apply(a,c(e.stopper,b))}function c(a,b){return a.map(function(a){return Array(b).join(" |")+" "+(a?a.toString():"[empty]")})}var a=[],b=1;d(this.current);return a.join("\n")},e.prototype.closed=function(){return this.stopper.length>0},e.prototype.asTag=function(a){this.tagName=a},f.modes={PRG:"PROGRAM",MKP:"MARKUP",BLK:"BLOCK",EXP:"EXPRESSION"},f.prototype={parse:function(){var a,b,c,d,e,g="Top 30 tokens ordered by TOUCHING";while(a=this.tokens.pop()){this.debug&&console.log(this.ast.current&&this.ast.current.type,a.type,a,a.val),this.ast.current.type===f.modes.PRG&&(this.ast.openNewAsChild(this.options.initialMode||f.modes.MKP),this.options.initialMode===f.modes.EXP&&this.ast.openNewAsChild(f.modes.EXP,null,!0));if(this.ast.current.type===f.modes.MKP){this.handleMKP(a);continue}if(this.ast.current.type===f.modes.BLK){this.handleBLK(a);continue}if(this.ast.current.type===f.modes.EXP){this.handleEXP(a);continue}}this.ast.root(),this.debug&&console.log(this.ast.toTreeString());return this.ast},exceptionFactory:function(a,b,c){switch(b){case"UNMATCHED":a.name="UnmatchedCharacterError",this.ast.root(),c&&(a.message="Unmatched "+c.type+" at line "+c.line+", character "+c.chr+". Value: "+c.val+"\n "+this.ast.toTreeString(),a.lineNumber=c.line);break;case"INVALIDINPUT":a.name="InvalidParserInputError",c&&(this.message="Asked to parse invalid or non-string input: "+c),this.lineNumber=0}return a},advanceUntilNot:function(a){var b,c,d=[];while(c=this.tokens[this.tokens.length-1])if(c.type===a)b=this.tokens.pop(),d.push(b);else break;return d},advanceUntilMatched:function(a,b,c){var d=a,e=0,f=0,g=[];while(d){d.type===b&&e++,d.type===c&&f++,g.push(d);if(e===f)break;d=this.tokens.pop();if(!d)throw this.exceptionFactory(new Error,"UNMATCHED",a)}return g.reverse()},handleMKP:function(a){var b=this.tokens[this.tokens.length-1],d=this.tokens[this.tokens.length-2],e=null,g;switch(a.type){case c.tks.AT_STAR_OPEN:this.advanceUntilMatched(a,c.tks.AT_STAR_OPEN,c.tks.AT_STAR_CLOSE);break;case c.tks.AT:if(b)switch(b.type){case c.tks.PAREN_OPEN:case c.tks.IDENTIFIER:case c.tks.HTML_RAW:this.ast.openNewAsChild(f.modes.EXP);break;case c.tks.KEYWORD:case c.tks.FUNCTION:case c.tks.BRACE_OPEN:case c.tks.BLOCK_GENERATOR:this.ast.openNewAsChild(f.modes.BLK);break;default:this.ast.useToken(this.tokens.pop())}break;case c.tks.BRACE_OPEN:this.ast.openNewAsChild(f.modes.BLK),this.tokens.push(a);break;case c.tks.BRACE_CLOSE:this.ast.closeCurrent(),this.tokens.push(a);break;case c.tks.TEXT_TAG_OPEN:case c.tks.HTML_TAG_OPEN:e=a.val.match(/^<([^\/ >]+)/i),e===null&&b&&b.type===c.tks.AT&&d&&(e=d.val.match(/(.*)/)),this.ast.openNewAsChild(f.modes.MKP),this.ast.current.asTag(e[1]),c.tks.HTML_TAG_OPEN===a.type&&this.ast.useToken(a);break;case c.tks.TEXT_TAG_CLOSE:case c.tks.HTML_TAG_CLOSE:c.tks.HTML_TAG_CLOSE===a.type&&(this.ast.useAsStopper(a),this.ast.closeCurrent()),this.ast.current.parent&&this.ast.current.parent.type===f.modes.BLK&&(b.type===c.tks.WHITESPACE||b.type===c.tks.NEWLINE)&&(this.ast.useToken(this.advanceUntilNot(c.tks.WHITESPACE)),this.ast.closeCurrent());break;default:this.ast.useToken(a)}},handleBLK:function(a){var d=this.tokens[this.tokens.length-1],e,g,h,i,j;switch(a.type){case c.tks.AT:switch(d.type){case c.tks.AT:break;default:this.tokens.push(a),this.ast.closeCurrent(),this.ast.openNewAsChild(f.modes.MKP)}break;case c.tks.AT_COLON:this.ast.openNewAsChild(f.modes.MKP);break;case c.tks.TEXT_TAG_OPEN:case c.tks.TEXT_TAG_CLOSE:case c.tks.HTML_TAG_SELFCLOSE:case c.tks.HTML_TAG_OPEN:case c.tks.HTML_TAG_CLOSE:this.ast.openNewAsChild(f.modes.MKP),this.tokens.push(a);break;case c.tks.FAT_ARROW:this.ast.openNewAsChild(f.modes.BLK,a);break;case c.tks.BRACE_OPEN:case c.tks.PAREN_OPEN:this.ast.current.closed()?this.ast.openNewAsSibling(f.modes.BLK,a):this.ast.useToken(a),h=b.copyObj(this.options),h.initialMode=f.modes.BLK,g=this.advanceUntilMatched(a,a.type,c.pairs[a.type]),g.pop(),this.ast.useAsStopper(g.shift()),i=new f(g,h),i.parse(),this.ast.current.children.push.apply(this.ast.current.children,i.ast.current.children);for(j=this.ast.current.children.length-1;j>=0;j--)this.ast.current.children[j].parent=this.ast.current;this.ast.closeCurrent();break;case c.tks.WHITESPACE:this.ast.useToken(a),this.advanceUntilNot(c.tks.WHITESPACE);break;default:this.ast.useToken(a)}},handleEXP:function(a){var d=null,e,g,h,i;switch(a.type){case c.tks.KEYWORD:case c.tks.FUNCTION:this.ast.openNewAsChild(f.modes.BLK),this.tokens.push(a);break;case c.tks.LOGICAL:case c.tks.ASSIGN_OPERATOR:case c.tks.OPERATOR:case c.tks.NUMERIC_CONTENT:case c.tks.WHITESPACE:case c.tks.IDENTIFIER:case c.tks.HTML_RAW:this.ast.useToken(a);break;case c.tks.SINGLE_QUOTE:case c.tks.DOUBLE_QUOTE:if(this.ast.current.parent.type!==f.modes.EXP){this.ast.closeCurrent(),this.tokens.push(a);break}this.ast.current.closed()?(this.ast.closeCurrent(),this.tokens.push(a)):(h=this.advanceUntilMatched(a,a.type,c.pairs[a.type]),this.ast.useToken(h));break;case c.tks.HARD_PAREN_OPEN:case c.tks.PAREN_OPEN:this.ast.current.closed()?this.ast.openNewAsSibling(f.modes.EXP,a):this.ast.useToken(a),parseOpts=b.copyObj(this.options),parseOpts.initialMode=f.modes.EXP,h=this.advanceUntilMatched(a,a.type,c.pairs[a.type]),h.pop(),this.ast.useAsStopper(h.shift()),g=new f(h,parseOpts),g.parse(),this.ast.current.children.push.apply(this.ast.current.children,g.ast.current.children[0].children);for(i=this.ast.current.children.length-1;i>=0;i--)this.ast.current.children[i].parent=this.ast.current;break;case c.tks.BRACE_OPEN:this.tokens.push(a),this.ast.openNewAsChild(f.modes.BLK);break;case c.tks.FAT_ARROW:this.tokens.push(a),this.ast.openNewAsChild(f.modes.BLK);break;case c.tks.PERIOD:d=this.tokens[this.tokens.length-1],!d||d.type!==c.tks.IDENTIFIER&&d.type!==c.tks.KEYWORD&&d.type!==c.tks.FUNCTION?(this.ast.closeCurrent(),this.tokens.push(a)):this.ast.useToken(a);break;default:this.ast.closeCurrent(),this.tokens.push(a)}}};var h=g.prototype;h.assemble=function(a){function n(a){var b,c;c=a.children.slice();while(b=c.shift())b.type===f.modes.MKP&&k(b),b.type===f.modes.BLK&&l(b),b.type===f.modes.EXP&&m(b)}function m(e){var g="",h="";e.children.length===0&&a.htmlEscape!==!1&&(g+="(",h+=").toString()\n.replace(/&(?!w+;)/g, '&amp;')\n.replace(/</g, '&lt;')\n.replace(/>/g, '&gt;')\n.replace(/\"/g, '&quot;') \n"),e.parent&&e.parent.type!==f.modes.EXP&&(g+="__vout.push(",h+="); \n"),b.push(g+j(e.starter).replace(c,'"').replace(d,'"')),n(e),b.push(j(e.stopper).replace(c,'"').replace(d,'"')+h)}function l(a){b.push(j(a.starter).replace(c,'"')),n(a),b.push(j(a.stopper).replace(c,'"'))}function k(d){if(d.starter.length!==0||d.stopper.length!==0||d.children.length!==0)d.starter.length>0&&a.debug&&b.push(";__vline = "+d.starter[0].line+"; \n")&&b.push(";__vchar = "+d.starter[0].chr+"; \n"),b.push("__vout.push('"+j(d.starter).replace(c,'"').replace(e,"\\n")+"'); \n"),n(d),d.stopper.length>0&&a.debug&&b.push(";__vline = "+d.stopper[0].line+"; \n")&&b.push(";__vchar = "+d.stopper[0].chr+"; \n"),b.push("__vout.push('"+j(d.stopper).replace(c,'"').replace(e,"\\n")+"'); \n")}function j(a){var b,c,d=[];for(b=0;b<a.length;b++)d.push(a[b].val);return d.join("")}a=a||{};var b=[],c=/["']/gi,d=/(\\?)(["'])/gi,e=/[\n\r]/gi,g,i;b.unshift("var __vout = []; \n"),a.debug&&b.push("var __vline = 0, __vchar = 0; \n"),n(this.ast.current),a.useWith===!0&&(b.unshift("with("+a.modelName+" || {}){ \n"),b.push("}")),a.debug&&(b.unshift("try { \n"),b.push("} catch(e){ (",h.reportError.toString(),")(e, __vline, __vchar, ",'"'+this.originalMarkup.replace(e,"!LB!").replace(d,"\\$2")+'"',") } \n")),b.push("return __vout.join('');"),g=b.join(""),a.debugCompiler&&console.log(g);try{i=new Function(a.modelName,g)}catch(o){o.message+=" -> "+g;throw o}return i},h.reportError=function(a,b,c,d){var e=d.split("!LB!"),f=3,g=Math.max(0,b-f),h=Math.min(e.length,b+f),i=e.slice(g,h).map(function(a,c,d){var e=c+g+1;return(e===b?"  > ":"    ")+e+" | "+a}).join("\n");a.message="Problem while rendering template at line "+b+", character "+c+".\nOriginal message: "+a.message+"."+"\nContext: \n\n"+i+"\n\n";throw a},a.isArray=function(a){return Object.prototype.toString.call(a)=="[object Array]"},a.copyObj=function(a){var b={};for(var c in a)Object.prototype.hasOwnProperty(c)&&(b[c]=a[c]);return b},a.VLexer=c,a.VParser=f,a.VCompiler=g,a.compile=function i(b,d){var e,h,i=[],j,k,l;d=d||{},d.useWith=d.useWith||a.config.useWith,d.modelName=d.modelName||a.config.modelName,d.debug=d.debug||a.config.debug,d.debugParser=d.debugParser||a.config.debugParser,d.debugCompiler=d.debugCompiler||a.config.debugCompiler,e=new c(b);while(h=e.advance())i.push(h);i.reverse(),j=new f(i,d),j.parse(),k=new g(j.ast,b),l=k.assemble(d),l.displayName="render";return l};return a}({}))
(function(a){typeof define=="function"&&define.amd?define(a):typeof module=="object"&&module.exports?module.exports=a:window.vash=a})(function(a){function Q(a,b){this.ast=a,this.originalMarkup=b||""}function L(a,b){this.options=b||{},this.tokens=a,this.ast=K(M)}function c(a){this.input=this.originalInput=a.replace(/\r\n|\r/g,"\n"),this.lineno=1,this.charno=0}var b=a;a.version="0.4.3-882",a.config={useWith:!1,modelName:"model",debug:!1,debugParser:!1,debugCompiler:!1},c.prototype={tok:function(a,b){return{type:a,line:this.lineno,chr:this.charno,val:b,toString:function(){return"["+this.type+" ("+this.line+","+this.chr+"): "+this.val+"]"}}},scan:function(a,b){var c,d;if(c=a.exec(this.input)){this.consume(c[0].length),d=this.tok(b,c[1]),this.charno+=c[0].length;return d}},spew:function(a){this.input=a+this.input,this.charno-=a.length},consume:function(a){this.input=this.input.substr(a)},spewIf:function(a,b){var c;a&&(c=a.val.split(b),c.length>1&&(a.val=c.shift(),this.spew(b+c.join(b))));return a},advance:function(){return this.next()},next:function(){return this.EMAIL()||this.AT_STAR_OPEN()||this.AT_STAR_CLOSE()||this.AT_COLON()||this.AT()||this.FAT_ARROW()||this.PAREN_OPEN()||this.PAREN_CLOSE()||this.HARD_PAREN_OPEN()||this.HARD_PAREN_CLOSE()||this.BRACE_OPEN()||this.BRACE_CLOSE()||this.TEXT_TAG_OPEN()||this.TEXT_TAG_CLOSE()||this.HTML_TAG_SELFCLOSE()||this.HTML_TAG_OPEN()||this.HTML_TAG_CLOSE()||this.PERIOD()||this.NEWLINE()||this.WHITESPACE()||this.FUNCTION()||this.KEYWORD()||this.HTML_RAW()||this.IDENTIFIER()||this.OPERATOR()||this.ASSIGN_OPERATOR()||this.LOGICAL()||this.BACKSLASH()||this.DOUBLE_QUOTE()||this.SINGLE_QUOTE()||this.NUMERIC_CONTENT()||this.CONTENT()},AT:function(){return this.scan(/^(@)/,d)},AT_COLON:function(){return this.scan(/^@\:/,g)},AT_STAR_OPEN:function(){return this.scan(/^(@\*)/,e)},AT_STAR_CLOSE:function(){return this.scan(/^(\*@)/,f)},PAREN_OPEN:function(){return this.scan(/^(\()/,i)},PAREN_CLOSE:function(){return this.scan(/^(\))/,j)},BRACE_OPEN:function(){return this.scan(/^(\{)/,k)},BRACE_CLOSE:function(){return this.scan(/^(\})/,l)},HARD_PAREN_OPEN:function(){return this.scan(/^(\[)/,m)},HARD_PAREN_CLOSE:function(){return this.scan(/^(\])/,n)},TEXT_TAG_OPEN:function(){return this.scan(/^(<text>)/,o)},TEXT_TAG_CLOSE:function(){return this.scan(/^(<\/text>)/,p)},HTML_TAG_SELFCLOSE:function(){return this.spewIf(this.scan(/^(<[^>]+?\/>)/,q),"@")},HTML_TAG_OPEN:function(){return this.spewIf(this.scan(/^(<[^\/ >]+?[^>]*?>)/,r),"@")},HTML_TAG_CLOSE:function(){return this.spewIf(this.scan(/^(<\/[^>\b]+?>)/,s),"@")},FAT_ARROW:function(){return this.scan(/^(\(.*?\)?\s*?=>)/,v)},FUNCTION:function(){return this.scan(/^(function)(?![\d\w])/,u)},KEYWORD:function(){return this.scan(/^(case|catch|do|else|finally|for|function|goto|if|instanceof|return|switch|try|typeof|var|while|with)(?![\d\w])/,t)},IDENTIFIER:function(){return this.scan(/^([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)/,w)},HTML_RAW:function(){return this.scan(/^(vash\.raw)(?![\d\w])/,J)},PERIOD:function(){return this.scan(/^(\.)/,x)},EMAIL:function(){return this.scan(/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})\b/,h)},ASSIGN_OPERATOR:function(){return this.scan(/^(\|=|\^=|&=|>>>=|>>=|<<=|-=|\+=|%=|\/=|\*=|=)/,y)},OPERATOR:function(){return this.scan(/^(===|!==|==|!==|>>>|<<|>>|>=|<=|>|<|\+|-|\/|\*|\^|%|\:|\?)/,D)},LOGICAL:function(){return this.scan(/^(&&|\|\||&|\||\^)/,E)},SINGLE_QUOTE:function(){return this.scan(/^(')/,z)},DOUBLE_QUOTE:function(){return this.scan(/^(")/,A)},BACKSLASH:function(){return this.scan(/^(\\)/,B)},NUMERIC_CONTENT:function(){return this.scan(/^([0-9]+)/,C)},CONTENT:function(){return this.scan(/^([^\s})@.]+?)/,F)},WHITESPACE:function(){return this.scan(/^(\s)/,G)},NEWLINE:function(){var a=this.scan(/^(\n)/,H);a&&(this.lineno++,this.charno=0);return a},EOF:function(){return this.scan(/^$/,I)}};var d="AT",e="AT_STAR_OPEN",f="AT_STAR_CLOSE",g="AT_COLON",h="EMAIL",i="PAREN_OPEN",j="PAREN_CLOSE",k="BRACE_OPEN",l="BRACE_CLOSE",m="HARD_PAREN_OPEN",n="HARD_PAREN_CLOSE",o="TEXT_TAG_OPEN",p="TEXT_TAG_CLOSE",q="HTML_TAG_SELFCLOSE",r="HTML_TAG_OPEN",s="HTML_TAG_CLOSE",t="KEYWORD",u="FUNCTION",v="FAT_ARROW",w="IDENTIFIER",x="PERIOD",y="ASSIGN_OPERATOR",z="SINGLE_QUOTE",A="DOUBLE_QUOTE",B="BACKSLASH",C="NUMERIC_CONTENT",D="OPERATOR",E="LOGICAL",F="CONTENT",G="WHITESPACE",H="NEWLINE",I="EOF",J="HTML_RAW";c.pairs={AT_STAR_OPEN:f,PAREN_OPEN:j,BRACE_OPEN:l,HARD_PAREN_OPEN:n,DOUBLE_QUOTE:A,SINGLE_QUOTE:z};var K=function(a){return new K.fn.init(a)};K.prototype.init=function(a){typeof a=="string"&&(this.mode=a),this.maxCheck()},K.fn=K.prototype.init.prototype=K.prototype,K.fn.vquery="yep",K.fn.constructor=K,K.fn.length=0,K.fn.parent=null,K.fn.mode=null,K.fn.tagName=null,K.fn.beget=function(a,b){var c=K();c.mode=a,c.parent=this,this.push(c),b&&(c.tagName=b),this.maxCheck();return c},K.fn.closest=function(a,b){var c=this;while(c)if(c.tagName!==b&&c.parent)c=c.parent;else break;return c},K.fn.pushFlatten=function(a){var b=a,c,d;while(b.length===1&&b[0].vquery)b=b[0];if(b.mode!==M)this.push(b);else for(c=0;c<b.length;c++)this.push(b[c]);this.maxCheck();return this},K.fn.push=function(a){K.isArray(a)?(a.vquery&&a.forEach(function(a){a.parent=this},this),Array.prototype.push.apply(this,a)):(a.vquery&&(a.parent=this),Array.prototype.push.call(this,a)),this.maxCheck();return this.length},K.fn.root=function(){var a=this;while(a&&a.parent&&(a=a.parent));return a},K.fn.toTreeString=function(){function c(d){var e,f;a.push(Array(b).join(" |")+" +"+d.mode+" "+(d.tagName||"")),b+=1,e=d.slice();while(f=e.shift())f.vquery===K.fn.vquery?c(f):a.push(Array(b).join(" |")+" "+(f?f.toString():"[empty]"));b-=1}var a=[],b=1;c(this);return a.join("\n")},K.fn.maxCheck=function(){if(this.length>=K.maxSize){var a=new Error;a.message="Maximum number of elements exceeded",a.name="vQueryDepthException";throw a}},K.maxSize=1e3,K.makeArray=function(a){a=Array.prototype.slice.call(a,0);return a},K.isArray=function(a){return Object.prototype.toString.call(a)=="[object Array]"},K.copyObj=function(a){var b={};for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b},K.takeMethodsFromArray=function(){var a=["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice","indexOf","lastIndexOf","filter","forEach","every","map","some","reduce","reduceRight"],b=[],c;for(var d=0;d<a.length;d++){c=a[d];if(typeof b[c]=="function")K.fn[c]||function(a){K.fn[a]=function(){return b[a].apply(this,K.makeArray(arguments))}}(c);else throw new Error("Vash requires ES5 array iteration methods, missing: "+c)}},K.takeMethodsFromArray();var M="PROGRAM",N="MARKUP",O="BLOCK",P="EXPRESSION";L.prototype={parse:function(){var a,b,c,d;while(a=this.tokens.pop()){this.options.debugParser&&console.log(this.ast&&this.ast.mode,a.type,a,a.val);if(this.ast.mode===M||this.ast.mode===null)this.ast=this.ast.beget(this.options.initialMode||N),this.options.initialMode===P&&(this.ast=this.ast.beget(P));if(this.ast.mode===N){this.handleMKP(a);continue}if(this.ast.mode===O){this.handleBLK(a);continue}if(this.ast.mode===P){this.handleEXP(a);continue}}this.ast=this.ast.root(),this.options.debugParser&&!this.options.initialMode&&(console.log(this.ast),console.log(this.ast.toTreeString()));return this.ast},exceptionFactory:function(a,b,c){b=="UNMATCHED"&&(a.name="UnmatchedCharacterError",this.ast.root(),c&&(a.message="Unmatched "+c.type+" at line "+c.line+", character "+c.chr+". Value: "+c.val+"\n "+this.ast.toTreeString(),a.lineNumber=c.line));return a},advanceUntilNot:function(a){var b,c,d=[];while(c=this.tokens[this.tokens.length-1])if(c.type===a)b=this.tokens.pop(),d.push(b);else break;return d},advanceUntilMatched:function(a,b,c,d,e){var f=a,g=null,h=0,i=0,j=[];while(f){f.type===b?g&&g.type!==escape&&b!==c||!g?h++:b===c&&i++:f.type===c&&(i++,g&&g.type===e&&i--),j.push(f);if(h===i)break;g=f,f=this.tokens.pop();if(!f)throw this.exceptionFactory(new Error,"UNMATCHED",a)}return j.reverse()},handleMKP:function(a){var b=this.tokens[this.tokens.length-1],c=this.tokens[this.tokens.length-2],g=null,h;switch(a.type){case e:this.advanceUntilMatched(a,e,f,d,d);break;case d:if(b)switch(b.type){case i:case w:case J:this.ast.length===0&&(this.ast=this.ast.parent,this.ast.pop()),this.ast=this.ast.beget(P);break;case t:case u:case k:this.ast.length===0&&(this.ast=this.ast.parent,this.ast.pop()),this.ast=this.ast.beget(O);break;default:this.ast.push(this.tokens.pop())}break;case k:this.ast=this.ast.beget(O),this.tokens.push(a);break;case l:this.ast=this.ast.parent,this.tokens.push(a);break;case o:case r:g=a.val.match(/^<([^\/ >]+)/i),g===null&&b&&b.type===d&&c&&(g=c.val.match(/(.*)/)),this.ast.tagName?this.ast=this.ast.beget(N,g[1]):this.ast.tagName=g[1],r===a.type&&this.ast.push(a);break;case p:case s:g=a.val.match(/^<\/([^>]+)/i),g===null&&b&&b.type===d&&c&&(g=c.val.match(/(.*)/)),h=this.ast.closest(N,g[1]),h!==null&&h.tagName===g[1]&&(this.ast=h),s===a.type&&this.ast.push(a),this.ast.parent&&this.ast.parent.mode===O&&(b.type===G||b.type===H)&&(this.ast=this.ast.parent);break;case q:this.ast.push(a),this.ast.parent&&this.ast.parent.mode===O&&(b.type===G||b.type===H)&&(this.ast=this.ast.parent);break;default:this.ast.push(a)}},handleBLK:function(a){var b=this.tokens[this.tokens.length-1],e,f,h,j,l,m;switch(a.type){case d:b.type!==d&&(this.tokens.push(a),this.ast=this.ast.beget(N));break;case g:this.ast=this.ast.beget(N);break;case o:case p:case q:case r:case s:this.ast=this.ast.beget(N),this.tokens.push(a);break;case v:this.ast=this.ast.beget(O);break;case k:case i:j=K.copyObj(this.options),j.initialMode=O,h=this.advanceUntilMatched(a,a.type,c.pairs[a.type],null,d),h.pop(),f=h.shift(),this.ast.push(a),l=new L(h,j),l.parse(),this.ast.pushFlatten(l.ast),this.ast.push(f),h=this.advanceUntilNot(G),b=this.tokens[this.tokens.length-1],b&&b.type!==t&&b.type!==u&&b.type!==k&&a.type!==i?(this.tokens.push.apply(this.tokens,h.reverse()),this.ast=this.ast.parent):this.ast.push(h);break;case G:this.ast.push(a),this.advanceUntilNot(G);break;default:this.ast.push(a)}},handleEXP:function(a){var b=null,e,f,g,h,j,l;switch(a.type){case t:case u:this.ast=this.ast.beget(O),this.tokens.push(a);break;case G:case E:case y:case D:case C:this.ast.parent&&this.ast.parent.mode===P?this.ast.push(a):(this.ast=this.ast.parent,this.tokens.push(a));break;case w:case J:this.ast.push(a);break;case z:case A:this.ast.parent&&this.ast.parent.mode===P?(j=this.advanceUntilMatched(a,a.type,c.pairs[a.type],B,B),this.ast.pushFlatten(j.reverse())):(this.ast=this.ast.parent,this.tokens.push(a));break;case m:case i:g=K.copyObj(this.options),g.initialMode=P,j=this.advanceUntilMatched(a,a.type,c.pairs[a.type],null,d),j.pop(),f=j.shift(),this.ast.push(a),h=new L(j,g),h.parse(),this.ast.pushFlatten(h.ast),this.ast.push(f),b=this.tokens[this.tokens.length-1],this.ast.parent&&this.ast.parent.mode!==P&&b&&b.type!==m&&b.type!==x&&(this.ast=this.ast.parent);break;case k:this.tokens.push(a),this.ast=this.ast.beget(O);break;case v:this.tokens.push(a),this.ast=this.ast.beget(O);break;case x:b=this.tokens[this.tokens.length-1],!b||b.type!==w&&b.type!==t&&b.type!==u&&b.type!==x?(this.ast=this.ast.parent,this.tokens.push(a)):this.ast.push(a);break;default:this.ast.parent&&this.ast.parent.mode!==P?(this.ast=this.ast.parent,this.tokens.push(a)):this.ast.push(a)}}};var R=Q.prototype;R.assemble=function(a){function n(a){return a.vquery&&a.mode===P?a.filter(n).length>0:a.vquery&&a.mode!==P?!0:!1}function m(a){var b,c=a.slice(0),d,e,f;a.mode===P&&a.parent&&a.parent.mode!==P&&(d=a.filter(n).length);for(e=0;e<c.length;e++)f=c[e],f.vquery?m(f):a.mode===N?j(f,a,e):a.mode===O?k(f,a,e):a.mode===P&&l(f,a,e,d>0?!1:!0)}function l(f,g,h,j){var k="",l="",m=g.parent&&g.parent.mode!==P;a.htmlEscape!==!1&&(f.type===J&&c.push(!0),m&&h===0&&j&&c.length===0&&(k+="( typeof (__vt = "),m&&h===g.length-1&&j&&(c.length>0?c.pop():l+=") !== 'undefined' ? __vt : '' ).toString()\n.replace(/&(?!w+;)/g, '&amp;')\n.replace(/</g, '&lt;')\n.replace(/>/g, '&gt;')\n.replace(/\"/g, '&quot;') \n")),m&&(h===0||h===1&&g[0].type===J)&&(i(f),k="__vo.push("+k),m&&(h===g.length-1||h===g.length-2&&g[g.length-1].type===J)&&(l+="); \n"),f.type!==J&&b.push(k+f.val.replace(d,'"').replace(e,'"')+l),m&&h===g.length-1&&i(f)}function k(a,c,e){b.push(a.val.replace(d,'"'))}function j(a,c,e){i(a),b.push("__vo.push('"+a.val.replace(d,'"').replace(f,"\\n")+"'); \n")}function i(c){a.debug&&(b.push("__vl = "+c.line+", "),b.push("__vc = "+c.chr+"; \n"))}a=a||{};var b=[],c=[],d=/["']/gi,e=/(\\?)(["'])/gi,f=/[\n\r]/gi,g,h;b.unshift("var __vo = [], __vt; \n"),a.debug&&b.push("var __vl = 0, __vc = 0; \n"),m(this.ast),a.useWith===!0&&(b.unshift("with("+a.modelName+" || {}){ \n"),b.push("}")),a.debug&&(b.unshift("try { \n"),b.push("} catch(e){ (",R.reportError.toString(),")(e, __vl, __vc, ",'"'+this.originalMarkup.replace(f,"!LB!").replace(e,"\\$2")+'"',") } \n")),b.push("return __vo.join('');"),g=b.join(""),a.debugCompiler&&console.log(g);try{h=new Function(a.modelName,g)}catch(o){o.message+=" -> "+g;throw o}return h},R.reportError=function(a,b,c,d){var e=d.split("!LB!"),f=3,g=Math.max(0,b-f),h=Math.min(e.length,b+f),i=e.slice(g,h).map(function(a,c,d){var e=c+g+1;return(e===b?"  > ":"    ")+e+" | "+a}).join("\n");a.message="Problem while rendering template at line "+b+", character "+c+".\nOriginal message: "+a.message+"."+"\nContext: \n\n"+i+"\n\n";throw a},a.VLexer=c,a.VParser=L,a.VCompiler=Q,a.compile=function(b,d){if(b===""||typeof b!="string")throw new Error("Empty or non-string cannot be compiled");var e,f,g=[],h,i,j;d=d||{},d.useWith=d.useWith||a.config.useWith,d.modelName=d.modelName||a.config.modelName,d.debug=d.debug||a.config.debug,d.debugParser=d.debugParser||a.config.debugParser,d.debugCompiler=d.debugCompiler||a.config.debugCompiler,e=new c(b);while(f=e.advance())g.push(f);g.reverse(),h=new L(g,d),h.parse(),i=new Q(h.ast,b),j=i.assemble(d),j.displayName="render";return j};return a}({}))
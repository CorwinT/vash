(function(a){typeof define=="function"&&define.amd?define(a):typeof module=="object"&&module.exports?module.exports=a:window.vash=a})(function(a){function e(a,b){this.tokens=a,this.originalMarkup=b,this.symbolTable={}}function d(a,e){e=e||{},this.lex=new b(a),this.tks=b.tks,this.blockStack=new c,this.mode=d.modes.MKP,this.buffer=[],this.buffers=[],this.debug=e.debugParser,this.consumedTokens=[];if(typeof a!="string"||a.length===0)throw this.exceptionFactory(new Error,"INVALIDINPUT",a)}function c(){this._stack=[]}function b(a){this.tokens=[],this.input=this.originalInput=a.replace(/\r\n|\r/g,"\n"),this.deferredTokens=[],this.stash=[],this.lineno=1,this.charno=0}a.version="0.4.1-576",a.config={useWith:!1,modelName:"model",debug:!1,debugParser:!1,debugCompiler:!1},b.prototype={tok:function(a,b){return{type:a,line:this.lineno,chr:this.charno,val:b,touched:0}},scan:function(a,b){var c,d;if(c=a.exec(this.input)){this.consume(c[0].length),d=this.tok(b,c[1]),this.charno+=c[0].length;return d}},spew:function(a){this.input=a+this.input,this.charno-=a.length},consume:function(a){this.input=this.input.substr(a)},spewIf:function(a,b){var c;a&&(a.touched+=1,c=a.val.split(b),c.length>1&&(a.val=c.shift(),a.touched+=1,this.spew(b+c.join(b))));return a},advance:function(){return this.deferred()||this.stashed()||this.next()},defer:function(a){a.touched+=1,this.deferredTokens.push(a)},lookahead:function(a){var b=a-this.stash.length;while(b-->0)this.stash.push(this.next());return this.stash[--a]},next:function(){return this.EMAIL()||this.AT_STAR_OPEN()||this.AT_STAR_CLOSE()||this.AT_COLON()||this.AT()||this.PAREN_OPEN()||this.PAREN_CLOSE()||this.HARD_PAREN_OPEN()||this.HARD_PAREN_CLOSE()||this.BRACE_OPEN()||this.BRACE_CLOSE()||this.TEXT_TAG_OPEN()||this.TEXT_TAG_CLOSE()||this.HTML_TAG_SELFCLOSE()||this.HTML_TAG_OPEN()||this.HTML_TAG_CLOSE()||this.PERIOD()||this.NEWLINE()||this.WHITESPACE()||this.FUNCTION()||this.KEYWORD()||this.HTML_RAW()||this.IDENTIFIER()||this.CONTENT()},deferred:function(){var a=this.deferredTokens.shift();if(a){a.touched+=1;return a}return!1},stashed:function(){var a=this.stash.shift();if(a){a.touched+=1;return a}return!1},AT:function(){return this.scan(/^(@)/,b.tks.AT)},AT_COLON:function(){return this.scan(/^@\:/,b.tks.AT_COLON)},AT_STAR_OPEN:function(){return this.scan(/^(@\*)/,b.tks.AT_STAR_OPEN)},AT_STAR_CLOSE:function(){return this.scan(/^(\*@)/,b.tks.AT_STAR_CLOSE)},PAREN_OPEN:function(){return this.scan(/^(\()/,b.tks.PAREN_OPEN)},PAREN_CLOSE:function(){return this.scan(/^(\))/,b.tks.PAREN_CLOSE)},BRACE_OPEN:function(){return this.scan(/^(\{)/,b.tks.BRACE_OPEN)},BRACE_CLOSE:function(){return this.scan(/^(\})/,b.tks.BRACE_CLOSE)},HARD_PAREN_OPEN:function(){return this.scan(/^(\[)/,b.tks.HARD_PAREN_OPEN)},HARD_PAREN_CLOSE:function(){return this.scan(/^(\])/,b.tks.HARD_PAREN_CLOSE)},TEXT_TAG_OPEN:function(){return this.scan(/^(<text>)/,b.tks.TEXT_TAG_OPEN)},TEXT_TAG_CLOSE:function(){return this.scan(/^(<\/text>)/,b.tks.TEXT_TAG_CLOSE)},HTML_TAG_SELFCLOSE:function(){return this.spewIf(this.scan(/^(<[^>]+?\/>)/,b.tks.HTML_TAG_SELFCLOSE),"@")},HTML_TAG_OPEN:function(){return this.spewIf(this.scan(/^(<[^\/ >]+?[^>]*?>)/,b.tks.HTML_TAG_OPEN),"@")},HTML_TAG_CLOSE:function(){return this.spewIf(this.scan(/^(<\/[^>\b]+?>)/,b.tks.HTML_TAG_CLOSE),"@")},FUNCTION:function(){return this.scan(/^(function)(?![\d\w])/,b.tks.FUNCTION)},KEYWORD:function(){return this.scan(/^(case|catch|do|else|finally|for|function|goto|if|instanceof|return|switch|try|typeof|var|while|with)(?![\d\w])/,b.tks.KEYWORD)},IDENTIFIER:function(){return this.scan(/^([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)/,b.tks.IDENTIFIER)},HTML_RAW:function(){return this.scan(/^(vash\.raw)(?![\d\w])/,b.tks.HTML_RAW)},PERIOD:function(){return this.scan(/^(\.)/,b.tks.PERIOD)},EMAIL:function(){return this.scan(/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})\b/,b.tks.EMAIL)},CONTENT:function(){return this.scan(/^([^\s})@.]+?)/,b.tks.CONTENT)},WHITESPACE:function(){return this.scan(/^(\s)/,b.tks.WHITESPACE)},NEWLINE:function(){var a=this.scan(/^(\n)/,b.tks.NEWLINE);a&&(this.lineno++,this.charno=0);return a},EOF:function(){return this.scan(/^$/,b.tks.EOF)}},b.tks={AT:"AT",AT_STAR_OPEN:"AT_STAR_OPEN",AT_STAR_CLOSE:"AT_STAR_CLOSE",AT_COLON:"AT_COLON",EMAIL:"EMAIL",PAREN_OPEN:"PAREN_OPEN",PAREN_CLOSE:"PAREN_CLOSE",BRACE_OPEN:"BRACE_OPEN",BRACE_CLOSE:"BRACE_CLOSE",HARD_PAREN_OPEN:"HARD_PAREN_OPEN",HARD_PAREN_CLOSE:"HARD_PAREN_CLOSE",TEXT_TAG_OPEN:"TEXT_TAG_OPEN",TEXT_TAG_CLOSE:"TEXT_TAG_CLOSE",HTML_TAG_SELFCLOSE:"HTML_TAG_SELFCLOSE",HTML_TAG_OPEN:"HTML_TAG_OPEN",HTML_TAG_CLOSE:"HTML_TAG_CLOSE",KEYWORD:"KEYWORD",FUNCTION:"FUNCTION",IDENTIFIER:"IDENTIFIER",PERIOD:"PERIOD",CONTENT:"CONTENT",WHITESPACE:"WHITESPACE",NEWLINE:"NEWLINE",EOF:"EOF",HTML_RAW:"HTML_RAW"},c.prototype={push:function(a){this._stack.push(a);return this},pop:function(){return this._stack.length>0?this._stack.pop():null},peek:function(){return this._stack.length>0?this._stack[this._stack.length-1]:null},count:function(){return this._stack.length},raw:function(){return this._stack}},d.modes={MKP:"MARKUP",BLK:"BLOCK",EXP:"EXPRESSION"},d.prototype={parse:function(){var a,b,c,e,f,g="Top 30 tokens ordered by TOUCHING";while(a=this.lex.advance()){this.debug&&console.log(this.mode,a.type,a,a.val);if(this.mode===d.modes.MKP){this._handleMKP(a);continue}if(this.mode===d.modes.BLK){this._handleBLK(a);continue}if(this.mode===d.modes.EXP){this._handleEXP(a);continue}}this._endMode(d.modes.MKP);for(b=0,c=this.blockStack.count();b<c;b++){e=this.blockStack.pop();if(e.type===d.modes.BLK)throw this.exceptionFactory(new Error,"UNMATCHED",e.tok)}this.debug&&(f=this.consumedTokens.sort(function(a,b){return b.touched-a.touched}),console.groupCollapsed?console.groupCollapsed(g):console.group?console.group(g):console.log(g),f.slice(0,30).forEach(function(a){console.log(a.touched,a)}),console.groupEnd&&console.groupEnd());return this.buffers},exceptionFactory:function(a,b,c){var d="",e;for(e=0;e<this.buffers.length;e++)d+=this.buffers[e].value;d.length>100&&(d=d.substring(d.length-100));switch(b){case"UNMATCHED":a.name="UnmatchedCharacterError",c&&(a.message="Unmatched "+c.type+' near: "'+d+'"'+" at line "+c.line+", character "+c.chr+". Value: "+c.val,a.lineNumber=c.line);break;case"INVALIDINPUT":a.name="InvalidParserInputError",c&&(this.message="Asked to parse invalid or non-string input: "+c),this.lineNumber=0}return a},_useToken:function(a){this.debug&&this.consumedTokens.push(a),this.buffer.push(a)},_useTokens:function(a){for(var b=0,c=a.length;b<c;b++)this.debug&&this.consumedTokens.push(a[b]),this.buffer.push(a[b])},_advanceUntilNot:function(a){var b,c,d=[];while(c=this.lex.lookahead(1))if(c.type===a)b=this.lex.advance(),d.push(b);else break;return d},_advanceUntilMatched:function(a,b,c){var d=a,e=0,f=0,g=[];while(d){d.type===b&&e++,d.type===c&&f++,g.push(d);if(e===f)break;d=this.lex.advance();if(!d)throw this.exceptionFactory(new Error,"UNMATCHED",a)}return g},_retconMode:function(a){this.mode=a},_endMode:function(a){if(this.buffer.length!==0){for(var b=0;b<this.buffer.length;b++)this.buffer[b].mode=this.mode,this.buffers.push(this.buffer[b]);this.buffer.length=0}this.mode=a||d.modes.MKP},_handleMKP:function(a){var b=this.lex.lookahead(1),c=this.lex.lookahead(2),e=null,f=null,g=[];switch(a.type){case this.tks.AT_STAR_OPEN:this._advanceUntilMatched(a,this.tks.AT_STAR_OPEN,this.tks.AT_STAR_CLOSE);break;case this.tks.AT:if(b)switch(b.type){case this.tks.PAREN_OPEN:case this.tks.IDENTIFIER:case this.tks.HTML_RAW:this._endMode(d.modes.EXP);break;case this.tks.KEYWORD:case this.tks.FUNCTION:case this.tks.BRACE_OPEN:case this.tks.BLOCK_GENERATOR:this._endMode(d.modes.BLK);break;default:this._useToken(this.lex.advance())}break;case this.tks.BRACE_OPEN:this._endMode(d.modes.BLK),this.lex.defer(a);break;case this.tks.BRACE_CLOSE:this._endMode(d.modes.BLK),this.lex.defer(a);break;case this.tks.TEXT_TAG_OPEN:case this.tks.HTML_TAG_OPEN:f=a.val.match(/^<([^\/ >]+)/i),f===null&&b&&b.type===this.tks.AT&&c&&(f=c.val.match(/(.*)/)),this.blockStack.push({type:d.modes.MKP,tag:f[1],tok:a}),this.tks.HTML_TAG_OPEN===a.type&&this._useToken(a);break;case this.tks.TEXT_TAG_CLOSE:case this.tks.HTML_TAG_CLOSE:f=a.val.match(/^<\/([^>]+)/i),f===null&&b&&b.type===this.tks.AT&&c&&(f=c.val.match(/(.*)/)),e=this.blockStack.pop();while(e!==null){if(e.type===d.modes.MKP&&f[1]===e.tag)break;g.push(e),e=this.blockStack.pop()}if(e===null)throw this.exceptionFactory(new Error,"UNMATCHED",a);this.blockStack.raw().push.apply(this.blockStack.raw(),g),this.tks.HTML_TAG_CLOSE===a.type&&this._useToken(a),e=this.blockStack.peek(),e!==null&&e.type===d.modes.BLK&&(b.type===this.tks.WHITESPACE||b.type===this.tks.NEWLINE)&&(this._useTokens(this._advanceUntilNot(this.tks.WHITESPACE)),this._endMode(d.modes.BLK));break;default:this._useToken(a)}},_handleBLK:function(a){var b=this.lex.lookahead(1),c=null,e=[];switch(a.type){case this.tks.AT:switch(b.type){case this.tks.AT:break;default:this.lex.defer(a),this._endMode(d.modes.MKP)}break;case this.tks.AT_COLON:this._endMode(d.modes.MKP);break;case this.tks.TEXT_TAG_OPEN:case this.tks.TEXT_TAG_CLOSE:case this.tks.HTML_TAG_SELFCLOSE:case this.tks.HTML_TAG_OPEN:case this.tks.HTML_TAG_CLOSE:this._endMode(d.modes.MKP),this.lex.defer(a);break;case this.tks.BRACE_OPEN:case this.tks.PAREN_OPEN:this.blockStack.push({type:d.modes.BLK,tok:a}),this._useToken(a);break;case this.tks.BRACE_CLOSE:case this.tks.PAREN_CLOSE:c=this.blockStack.pop();while(c!==null&&c.type!==d.modes.BLK)e.push(c),c=this.blockStack.pop();this.blockStack.raw().push.apply(this.blockStack.raw(),e);if(c===null||c!==null&&c.type!==d.modes.BLK)throw this.exceptionFactory(new Error,"UNMATCHED",a);this._useToken(a),this._advanceUntilNot(this.tks.WHITESPACE),b=this.lex.lookahead(1);if(b&&(b.type===this.tks.KEYWORD||b.type===this.tks.FUNCTION))break;c=this.blockStack.peek(),c!==null&&c.type===d.modes.MKP&&this._endMode(d.modes.MKP);break;case this.tks.WHITESPACE:this._useToken(a),this._advanceUntilNot(this.tks.WHITESPACE);break;default:this._useToken(a)}},_handleEXP:function(a){var b=null;switch(a.type){case this.tks.KEYWORD:case this.tks.FUNCTION:this._endMode(d.modes.BLK),this.lex.defer(a);break;case this.tks.IDENTIFIER:case this.tks.HTML_RAW:this._useToken(a);break;case this.tks.HARD_PAREN_OPEN:this._useTokens(this._advanceUntilMatched(a,this.tks.HARD_PAREN_OPEN,this.tks.HARD_PAREN_CLOSE)),b=this.lex.lookahead(1),b&&b.type===this.tks.IDENTIFIER&&this._endMode(d.modes.MKP);break;case this.tks.PAREN_OPEN:b=this.lex.lookahead(1),!b||b.type!==this.tks.KEYWORD&&b.type!==this.tks.FUNCTION?(this._useTokens(this._advanceUntilMatched(a,this.tks.PAREN_OPEN,this.tks.PAREN_CLOSE)),b=this.lex.lookahead(1),b&&b.type===this.tks.IDENTIFIER&&this._endMode(d.modes.MKP)):(this.lex.defer(a),this._retconMode(d.modes.BLK));break;case this.tks.PERIOD:b=this.lex.lookahead(1),!b||b.type!==this.tks.IDENTIFIER&&b.type!==this.tks.KEYWORD&&b.type!==this.tks.FUNCTION?(this._endMode(d.modes.MKP),this.lex.defer(a)):this._useToken(a);break;default:this._endMode(d.modes.MKP),this.lex.defer(a)}}};var f=e.prototype;f.generate=function(a){this.buildSymbolTable(),this.insertHTMLExpressionEscape(a),this.mergeTokens()},f.assemble=function(a){var b,c,e=[],g=/[\"']/gi,h=/[\n\r]/gi,i,j;e.push("var __vout = []; \n"),a.debug&&e.push("var __vline = 0, __vchar = 0;");for(b=0;b<this.tokens.length;b++)c=this.tokens[b],a.debugCompiler&&console.log(c),a.debug&&e.push("__vline = "+c.line+"; __vchar = "+c.chr+";"),c.val=c.val.replace(g,'"'),c.mode===d.modes.MKP&&e.push("__vout.push('"+c.val.replace(h,"\\n")+"');"),c.mode===d.modes.BLK&&e.push(c.val.replace(h,"")),c.mode===d.modes.EXP&&e.push("__vout.push("+c.val.replace(h,"\\n")+");");a.useWith===!0&&(e.unshift("with("+a.modelName+" || {}){ \n"),e.push("}")),a.debug&&(e.unshift("try { \n"),e.push("} catch(e){ (",f.reportError.toString(),")(e, __vline, __vchar, ",'"'+this.originalMarkup.replace(h,"!LB!").replace(/(["'])/g,"\\$1")+'"',") } \n")),e.push("return __vout.join('');"),i=e.join(""),a.debugCompiler&&console.log(i);try{j=new Function(a.modelName,i)}catch(k){k.message+=" -> "+i;throw k}return j},f.mergeTokens=function(){var a=[],b=this.tokens[0],c,d;for(d=1;d<this.tokens.length;d++)c=this.tokens[d],b.mode===c.mode?(b.val+=c.val,b.type+=" "+c.type):(a.push(b),b=c);a.push(b),this.tokens=a;return this.tokens},f.insertHTMLExpressionEscape=function(a){var c,e,f,g=!1,h,i;for(c=0;c<this.tokens.length;c++){e=this.tokens[c],f=-1;if(e.mode!==d.modes.EXP)continue;if(e.type===b.tks.HTML_RAW){e.val="",h=this.deeperIndexOf(this.tokens,"type",b.tks.PAREN_OPEN,c),i=this.findMatchingIndex(this.tokens,b.tks.PAREN_OPEN,b.tks.PAREN_CLOSE,h),this.tokens[h].val="",this.tokens[i].val="",c=i;continue}if(this.symbolTable[e.val]===!0){f=Math.max(this.tokens.length-1,this.deeperIndexOfNot(this.tokens,"mode",d.modes.EXP,c)-1),c=f;continue}if(a.htmlEscape===!1)continue;f=this.deeperIndexOfNot(this.tokens,"mode",d.modes.EXP,c),f===-1&&this.tokens.length===1&&(f=1,g=!0),this.tokens.splice(c,0,{mode:d.modes.EXP,type:"EXP_GENERATED",touched:1,val:"(",line:e.line,chr:e.chr}),this.tokens.splice(f+1,0,{mode:d.modes.EXP,type:"EXP_GENERATED",touched:1,val:").toString().replace(/&(?!w+;)/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;')",line:this.tokens[f].line,chr:this.tokens[f].chr}),g==!1?c=f+1:c=f+2}return this.tokens},f.buildSymbolTable=function(){this.symbolTable={};var a,c,d,e;for(a=0;a<this.tokens.length;a++){c=this.tokens[a];if(c.type===b.tks.FUNCTION){d=this.deeperIndexOf(this.tokens,"type",b.tks.IDENTIFIER,a),e=this.deeperIndexOf(this.tokens,"type",b.tks.PAREN_OPEN,a);if(d>e)continue;this.symbolTable[this.tokens[d].val]=!0}}return this.symbolTable},f.deeperIndexOf=function(a,b,c,d){d=d||0;var e,f=-1;for(e=d;e<a.length;e++)if(a[e][b]===c){f=e;break}return f},f.deeperIndexOfNot=function(a,b,c,d){d=d||0;var e,f=-1;for(e=d;e<a.length;e++)if(a[e][b]!==c){f=e;break}return f},f.findMatchingIndex=function(a,b,c,d){var e=0,f=0,g=d||0,h;for(;g<a.length;g++){h=a[g],h.type===b&&e++,h.type===c&&f++;if(e===f)break}return g},f.reportError=function(a,b,c,d){var e=d.split("!LB!"),f=3,g=Math.max(0,b-f),h=Math.min(e.length,b+f);console.log(g,h);var i=e.slice(g,h).map(function(a,c,d){var e=c+g+1;return(e===b?"  > ":"    ")+e+" | "+a+"\n"});a.message="Problem while rendering template at line "+b+", character "+c+".\nOriginal message: "+a.message+"."+"\nContext: \n\n"+i;throw a},a.VLexer=b,a.VParser=d,a.VCompiler=e,a.compile=function g(b,c){var f,g,h;c=c||{},c.useWith=c.useWith||a.config.useWith,c.modelName=c.modelName||a.config.modelName,c.debug=c.debug||a.config.debug,c.debugParser=c.debugParser||a.config.debugParser,c.debugCompiler=c.debugCompiler||a.config.debugCompiler,f=new d(b,c),f.parse(),g=new e(f.buffers,f.lex.originalInput),g.generate(c),h=g.assemble(c),h.displayName="render";return h};return a}({}))
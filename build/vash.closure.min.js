(function(h){"function"===typeof define&&define.amd?define(h):"object"===typeof module&&module.exports?module.exports=h:window.vash=h})(function(h){function w(a){this.input=this.originalInput=a.replace(/\r\n|\r/g,"\n");this.lineno=1;this.charno=0}function l(a,c){this.options=c||{};this.tokens=a;this.ast=e(j);this.prevTokens=[]}function x(a,c){this.ast=a;this.originalMarkup=c||""}h.version="0.5.0-1031";h.config={useWith:!1,modelName:"model",helpersName:"html",htmlEscape:!0,debug:!1,debugParser:!1,
debugCompiler:!1,favorText:!1,saveTextTag:!1,saveAT:!1};var f={config:{}},C=/[&<>"'`]/g,E=function(a){return D[a]},D={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};f.raw=function(a){var c=function(){return a},a=null!=a?a:"";return{toHtmlString:c,toString:c}};f.escape=function(a){var c=function(){return a},a=null!=a?a:"";return"function"!==typeof a.toHtmlString?(a=a.toString().replace(C,E),{toHtmlString:c,toString:c}):a};f.buffer={mark:function(){return f.__vo.length},empty:function(){return f.__vo.splice(0,
f.__vo.length)},fromMark:function(a){return f.__vo.splice(a,f.__vo.length)},push:function(a){a instanceof Array?f.__vo.push.apply(f.__vo,a):1<arguments.length?f.__vo.push.apply(f.__vo,Array.prototype.slice.call(arguments)):f.__vo.push(a)}};"function"===typeof define&&define.amd?define(f):"object"===typeof module&&module.exports?h.helpers=f:(window.vash=window.vash||{},window.vash.helpers=f);var p="function"===typeof define&&define.amd?{}:"object"===typeof module&&module.exports?h.helpers:window.vash.helpers;
p.config.highlighter=null;p.highlight=function(a,c){var b=this.buffer.mark();c();b=this.buffer.fromMark(b);this.buffer.push("<pre><code>");p.config.highlighter&&this.buffer.push(p.config.highlighter(a,b.join("")).value);this.buffer.push("</code></pre>")};var z={AT_STAR_OPEN:"AT_STAR_CLOSE",BRACE_OPEN:"BRACE_CLOSE",DOUBLE_QUOTE:"DOUBLE_QUOTE",HARD_PAREN_OPEN:"HARD_PAREN_CLOSE",PAREN_OPEN:"PAREN_CLOSE",SINGLE_QUOTE:"SINGLE_QUOTE"},v=["EMAIL",/^([a-zA-Z0-9._%\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,4})\b/,"AT_STAR_OPEN",
/^(@\*)/,"AT_STAR_CLOSE",/^(\*@)/,"AT_COLON",/^@\:/,"AT",/^(@)/,"FAT_ARROW",/^(\(.*?\)?\s*?=>)/,"PAREN_OPEN",/^(\()/,"PAREN_CLOSE",/^(\))/,"HARD_PAREN_OPEN",/^(\[)/,"HARD_PAREN_CLOSE",/^(\])/,"BRACE_OPEN",/^(\{)/,"BRACE_CLOSE",/^(\})/,"TEXT_TAG_OPEN",/^(<text>)/,"TEXT_TAG_CLOSE",/^(<\/text>)/,"HTML_TAG_SELFCLOSE",/^(<[^@>]+?\/>)/,"HTML_TAG_OPEN",function(){return this.spewIf(this.scan(/^(<[^\/ >]+?[^>]*?>)/,"HTML_TAG_OPEN"),"@")},"HTML_TAG_CLOSE",/^(<\/[^>@\b]+?>)/,"PERIOD",/^(\.)/,"NEWLINE",function(){var a=
this.scan(/^(\n)/,"NEWLINE");if(a){this.lineno++;this.charno=0}return a},"WHITESPACE",/^(\s)/,"FUNCTION",/^(function)(?![\d\w])/,"KEYWORD",/^(case|catch|do|else|finally|for|function|goto|if|instanceof|return|switch|try|typeof|var|while|with)(?![\d\w])/,"IDENTIFIER",/^([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)/,"OPERATOR",/^(===|!==|==|!==|>>>|<<|>>|>=|<=|>|<|\+|-|\/|\*|\^|%|\:|\?)/,"ASSIGN_OPERATOR",/^(\|=|\^=|&=|>>>=|>>=|<<=|-=|\+=|%=|\/=|\*=|=)/,"LOGICAL",/^(&&|\|\||&|\||\^)/,"BACKSLASH",
/^(\\)/,"DOUBLE_QUOTE",/^(\")/,"SINGLE_QUOTE",/^(\')/,"NUMERIC_CONTENT",/^([0-9]+)/,"CONTENT",/^([^\s})@.]+?)/];w.prototype={scan:function(a,c){var b,d;if(b=a.exec(this.input)){this.input=this.input.substr(b[0].length);d={type:c,line:this.lineno,chr:this.charno,val:b[1],toString:function(){return"["+this.type+" ("+this.line+","+this.chr+"): "+this.val+"]"}};this.charno=this.charno+b[0].length;return d}},spewIf:function(a,c){var b;if(a){b=a.val.split(c);if(b.length>1){a.val=b.shift();b=c+b.join(c);
this.input=b+this.input;this.charno=this.charno-b.length}}return a},advance:function(){var a,c,b;for(a=0;a<v.length;a=a+2){c=v[a+1];c.displayName=v[a];typeof c==="function"&&(b=c.call(this));typeof c.exec==="function"&&(b=this.scan(c,v[a]));if(b)return b}}};var e=function(a){return new e.fn.init(a)};e.prototype.init=function(a){if(typeof a==="string")this.mode=a;this.maxCheck()};e.fn=e.prototype.init.prototype=e.prototype;e.fn.vquery="yep";e.fn.constructor=e;e.fn.length=0;e.fn.parent=null;e.fn.mode=
null;e.fn.tagName=null;e.fn.beget=function(a,c){var b=e(a);b.parent=this;this.push(b);if(c)b.tagName=c;this.maxCheck();return b};e.fn.closest=function(a,c){for(var b=this;b;)if(b.tagName!==c&&b.parent)b=b.parent;else break;return b};e.fn.pushFlatten=function(a){for(var c;a.length===1&&a[0].vquery;)a=a[0];if(a.mode!==j)this.push(a);else for(c=0;c<a.length;c++)this.push(a[c]);this.maxCheck();return this};e.fn.push=function(a){if(e.isArray(a)){a.vquery&&a.forEach(function(a){a.parent=this},this);Array.prototype.push.apply(this,
a)}else{if(a.vquery)a.parent=this;Array.prototype.push.call(this,a)}this.maxCheck();return this.length};e.fn.root=function(){for(var a=this;a&&a.parent&&(a=a.parent););return a};e.fn.toTreeString=function(){function a(d){var A,g;c.push(Array(b).join(" |")+" +"+d.mode+" "+(d.tagName||""));b=b+1;for(A=d.slice();g=A.shift();)g.vquery===e.fn.vquery?a(g):c.push(Array(b).join(" |")+" "+(g?g.toString().replace(/(\r|\n)/g,""):"[empty]"));b=b-1;c.push(Array(b).join(" |")+" -"+d.mode+" "+(d.tagName||""))}var c=
[],b=1;a(this);return c.join("\n")};e.fn.maxCheck=function(){if(this.length>=e.maxSize){var a=Error();a.message="Maximum number of elements exceeded";a.name="vQueryDepthException";throw a;}};e.maxSize=1E3;e.fn.flatten=function(){var a;return this.reduce(function b(d,e,g,f){if(e.vquery){d.push({type:"META",val:"START"+e.mode,tagName:e.tagName});a=e.reduce(b,d);a.push({type:"META",val:"END"+e.mode,tagName:e.tagName});return a}e.mode=f.mode;d.push(e);return d},[])};e.reconstitute=function(a){return a.reduce(function(a,
b){if(b.type==="META")a=a.parent;else{b.mode!==a.mode&&(a=a.beget(b.mode,b.tagName));a.push(b)}return a},e(j))};e.isArray=function(a){return Object.prototype.toString.call(a)=="[object Array]"};e.extend=function(a){var c,b,d;for(b=1;b<arguments.length;b++){c=arguments[b];for(d in c)a[d]=c[d]}return a};e.takeMethodsFromArray=function(){for(var a=["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice","indexOf","lastIndexOf","filter","forEach","every","map","some","reduce",
"reduceRight"],c=[],b,d=0;d<a.length;d++){b=a[d];if(typeof c[b]==="function")e.fn[b]||function(a){e.fn[a]=function(){return c[a].apply(this,Array.prototype.slice.call(arguments,0))}}(b);else throw Error("Vash requires ES5 array iteration methods, missing: "+b);}};e.takeMethodsFromArray();var j="PROGRAM",o="MARKUP",m="BLOCK",i="EXPRESSION";l.prototype={parse:function(){for(var a;this.prevTokens.push(a),a=this.tokens.pop();){this.options.debugParser&&console.log(this.ast&&this.ast.mode,a.type,a,a.val);
if(this.ast.mode===j||this.ast.mode===null){this.ast=this.ast.beget(this.options.initialMode||o);if(this.options.initialMode===i)this.ast=this.ast.beget(i)}this.ast.mode===o?this.handleMKP(a):this.ast.mode===m?this.handleBLK(a):this.ast.mode===i&&this.handleEXP(a)}this.ast=this.ast.root();if(this.options.debugParser&&!this.options.initialMode){console.log(this.ast);console.log(this.ast.toTreeString())}return this.ast},exceptionFactory:function(a,c,b){if(c=="UNMATCHED"){a.name="UnmatchedCharacterError";
this.ast=this.ast.root();if(b){a.message="Unmatched "+b.type+" at line "+b.line+", character "+b.chr+". Value: "+b.val+"\n "+this.ast.toTreeString();a.lineNumber=b.line}}return a},advanceUntilNot:function(a){for(var c,b=[];c=this.tokens[this.tokens.length-1];)if(c.type===a){c=this.tokens.pop();b.push(c)}else break;return b},advanceUntilMatched:function(a,c,b,d,e){for(var d=a,g=null,f=0,h=0,i=[];d;){if(d.type===c)g&&g.type!==escape&&c!==b||!g?f++:c===b&&h++;else if(d.type===b){h++;g&&g.type===e&&h--}i.push(d);
if(f===h)break;g=d;d=this.tokens.pop();if(!d)throw this.exceptionFactory(Error(),"UNMATCHED",a);}return i.reverse()},subParse:function(a,c){var b,d,f=e.extend({},this.options);f.initialMode=c;b=this.advanceUntilMatched(a,a.type,z[a.type],null,"AT");b.pop();d=b.shift();this.ast.push(a);b=new l(b,f);b.parse();this.ast.pushFlatten(b.ast);this.ast.push(d)},handleMKP:function(a){var c=this.tokens[this.tokens.length-1],b=this.tokens[this.tokens.length-2],d=null;switch(a.type){case "AT_STAR_OPEN":this.advanceUntilMatched(a,
"AT_STAR_OPEN","AT_STAR_CLOSE","AT","AT");break;case "AT":if(c)switch(c.type){case "PAREN_OPEN":case "IDENTIFIER":if(this.ast.length===0){this.ast=this.ast.parent;this.ast.pop()}this.ast=this.ast.beget(i);this.options.saveAT&&this.ast.push(a);break;case "KEYWORD":case "FUNCTION":case "BRACE_OPEN":if(this.ast.length===0){this.ast=this.ast.parent;this.ast.pop()}this.ast=this.ast.beget(m);this.options.saveAT&&this.ast.push(a);break;default:this.options.saveAT&&this.ast.push(a);this.ast.push(this.tokens.pop())}break;
case "BRACE_OPEN":if(this.options.favorText)this.ast.push(a);else{this.ast=this.ast.beget(m);this.tokens.push(a)}break;case "BRACE_CLOSE":if(this.options.favorText)this.ast.push(a);else{this.ast=this.ast.parent;this.tokens.push(a)}break;case "TEXT_TAG_OPEN":case "HTML_TAG_OPEN":d=a.val.match(/^<([^\/ >]+)/i);d===null&&(c&&c.type==="AT"&&b)&&(d=b.val.match(/(.*)/));this.ast.tagName?this.ast=this.ast.beget(o,d[1]):this.ast.tagName=d[1];("HTML_TAG_OPEN"===a.type||this.options.saveTextTag)&&this.ast.push(a);
break;case "TEXT_TAG_CLOSE":case "HTML_TAG_CLOSE":d=a.val.match(/^<\/([^>]+)/i);d===null&&(c&&c.type==="AT"&&b)&&(d=b.val.match(/(.*)/));b=this.ast.closest(o,d[1]);if(!(b===null||b.tagName!==d[1]))this.ast=b;("HTML_TAG_CLOSE"===a.type||this.options.saveTextTag)&&this.ast.push(a);if(this.ast.parent&&this.ast.parent.mode===m&&c&&(c.type==="WHITESPACE"||c.type==="NEWLINE"))this.ast=this.ast.parent;break;case "HTML_TAG_SELFCLOSE":this.ast.push(a);if(this.ast.parent&&this.ast.parent.mode===m&&c&&(c.type===
"WHITESPACE"||c.type==="NEWLINE"))this.ast=this.ast.parent;break;default:this.ast.push(a)}},handleBLK:function(a){var c=this.tokens[this.tokens.length-1],b;switch(a.type){case "AT":if(c.type!=="AT"){this.tokens.push(a);this.ast=this.ast.beget(o)}break;case "AT_COLON":this.ast=this.ast.beget(o);break;case "TEXT_TAG_OPEN":case "TEXT_TAG_CLOSE":case "HTML_TAG_SELFCLOSE":case "HTML_TAG_OPEN":case "HTML_TAG_CLOSE":this.ast=this.ast.beget(o);this.tokens.push(a);break;case "BRACE_OPEN":case "PAREN_OPEN":this.subParse(a,
m);b=this.advanceUntilNot("WHITESPACE");if((c=this.tokens[this.tokens.length-1])&&c.type!=="KEYWORD"&&c.type!=="FUNCTION"&&c.type!=="BRACE_OPEN"&&a.type!=="PAREN_OPEN"){this.tokens.push.apply(this.tokens,b.reverse());this.ast=this.ast.parent}else this.ast.push(b);break;case "WHITESPACE":this.ast.push(a);this.advanceUntilNot("WHITESPACE");break;default:this.ast.push(a)}},handleEXP:function(a){var c=null,b;switch(a.type){case "KEYWORD":case "FUNCTION":this.ast=this.ast.beget(m);this.tokens.push(a);
break;case "WHITESPACE":case "LOGICAL":case "ASSIGN_OPERATOR":case "OPERATOR":case "NUMERIC_CONTENT":if(this.ast.parent&&this.ast.parent.mode===i)this.ast.push(a);else{this.ast=this.ast.parent;this.tokens.push(a)}break;case "IDENTIFIER":this.ast.push(a);break;case "SINGLE_QUOTE":case "DOUBLE_QUOTE":if(this.ast.parent&&this.ast.parent.mode===i){a=this.advanceUntilMatched(a,a.type,z[a.type],"BACKSLASH","BACKSLASH");this.ast.pushFlatten(a.reverse())}else{this.ast=this.ast.parent;this.tokens.push(a)}break;
case "HARD_PAREN_OPEN":case "PAREN_OPEN":b=this.prevTokens[this.prevTokens.length-1];this.subParse(a,i);c=this.tokens[this.tokens.length-1];if(b&&b.type==="AT"||c&&c.type==="IDENTIFIER")this.ast=this.ast.parent;break;case "BRACE_OPEN":this.tokens.push(a);this.ast=this.ast.beget(m);break;case "FAT_ARROW":this.tokens.push(a);this.ast=this.ast.beget(m);break;case "PERIOD":if((c=this.tokens[this.tokens.length-1])&&(c.type==="IDENTIFIER"||c.type==="KEYWORD"||c.type==="FUNCTION"||c.type==="PERIOD"))this.ast.push(a);
else{this.ast=this.ast.parent;this.tokens.push(a)}break;default:if(this.ast.parent&&this.ast.parent.mode!==i){this.ast=this.ast.parent;this.tokens.push(a)}else this.ast.push(a)}}};var y=x.prototype;y.assemble=function(a,c){function b(b){a.debug&&g.push(a.helpersName+".__vl = __vl = "+b.line+", ",a.helpersName+".__vc = __vc = "+b.chr+"; \n")}function d(c){var k=c.slice(0),l,j,n;if(c.mode===i&&c.parent&&c.parent.mode!==i)l=c.filter(e).length;for(j=0;j<k.length;j++){n=k[j];if(n.vquery)d(n);else if(c.mode===
o){b(n);g.push("MKP('"+n.val.replace(f,'"').replace(B,"\\n")+"')MKP")}else if(c.mode===m)g.push(n.val.replace(f,'"'));else if(c.mode===i){var q=c,r=j,p=l>0?false:true,s="",t="",u=q.parent&&q.parent.mode!==i;if(a.htmlEscape!==false){u&&(r===0&&p)&&(s=s+(a.helpersName+".escape("));u&&(r===q.length-1&&p)&&(t=t+").toHtmlString() \n")}if(u&&r===0){b(n);s="__vo.push("+s}u&&r===q.length-1&&(t=t+"); \n");g.push(s+n.val.replace(f,'"').replace(h,'"')+t);u&&r===q.length-1&&b(n)}}}function e(a){return a.vquery&&
a.mode===i?a.filter(e).length>0:a.vquery&&a.mode!==i?true:false}var a=a||{},c=c||{},g=[],f=/["']/gi,h=/(\\?)(["'])/gi,B=/[\n\r]/gi,k,l;g.push("var __vo = []; \n");g.push(a.helpersName+".__vo = __vo; \n");a.debug&&g.push("var __vl = "+a.helpersName+".__vl = 0,","__vc = "+a.helpersName+".__vc = 0; \n");d(this.ast);if(a.useWith===true){g.unshift("with("+a.modelName+" || {}){ \n");g.push("}")}if(a.debug){g.unshift("try { \n");g.push("} catch(e){ (",y.reportError.toString(),")(e, __vl, __vc, ",'"'+this.originalMarkup.replace(B,
"!LB!").replace(h,"\\$2")+'"',") } \n")}g.push("delete "+a.helpersName+".__vo; \n");if(a.debug){g.push("delete "+a.helpersName+".__vl \n");g.push("delete "+a.helpersName+".__vc \n")}g.push("return __vo.join(''); \n");k=g.join("");k=k.split("')MKPMKP('").join("").split("MKP(").join("__vo.push(").split(")MKP").join("); \n");a.debugCompiler&&console.log(k);try{l=new Function(a.modelName,a.helpersName,k)}catch(j){j.message=j.message+(" -> "+k);throw j;}k=function(a){return l(a,c)};k.toString=function(){return l.toString()};
return k};y.reportError=function(a,c,b,d){var d=d.split("!LB!"),e=Math.max(0,c-3),g=Math.min(d.length,c+3),d=d.slice(e,g).map(function(a,b){var d=b+e+1;return(d===c?"  > ":"    ")+d+" | "+a}).join("\n");a.message="Problem while rendering template at line "+c+", character "+b+".\nOriginal message: "+a.message+".\nContext: \n\n"+d+"\n\n";throw a;};h.VLexer=w;h.VParser=l;h.VCompiler=x;h.compile=function(a,c){if(a===""||typeof a!=="string")throw Error("Empty or non-string cannot be compiled");var b,d,
f=[],c=e.extend({},h.config,c||{});for(b=new w(a);d=b.advance();)f.push(d);f.reverse();b=new l(f,c);b.parse();b=(new x(b.ast,a)).assemble(c,h.helpers);b.displayName="render";return b};return h}({}));
